
## Welcome to the Documentation for ATS Model Data Archiving (MDA) Reporting Format

- Advanced Terrestrial Simulator (ATS) is an open-source, multiphysics numerical modeling code used for solving complex ecohydrology and earth system problems. It's a powerful tool for simulating integrated, distributed hydrology at watershed-to-river basin scales.
  Reference: https://amanzi.github.io/ats/stable/

  ![ats_coweeta](.gitbook/assets/ats_coweeta.png)
- Funded by the U.S. Department of Energy’s Office of Science Biological and Environmental Research (BER) program under its Environmental System Science (ESS) program, ESS-DIVE (Environmental System Science Data Infrastructure for a Virtual Ecosystem) is a data repository for earth and environmental science data.
  Reference: https://ess-dive.lbl.gov/

  ![ess-dive-site-title-logo](.gitbook/assets/ess-dive-site-title-logo.png)
- Model Data Archiving (MDA) is a data reporting format and a set of instructions developed to guide the archival and sharing of data generated from environmental model simulations.
  Reference: https://github.com/ess-dive-workspace/essdive-ATS-model-data-archiving/

  ![ats_mda_gemini_6](.gitbook/assets/ats_mda_gemini_6.png)


# ATS MDA Reporting Format Documentation

This document aims to outline the motivation, review the fundamentals of ATS inputs and outputs, examine the existing MDA Reporting Format, and provide a detailed guide on creating and managing ATS MDAs using the improved Reporting Format.


## Background

Managing and archiving the diverse data types used and generated by watershed- or basin-scale hydrologic models pose significant challenges due to the models’ complexity, spatiotemporal heterogeneity, and the large size of the associated datasets.

The utilization of iterative model-experiment ([ModEx](https://ess.science.energy.gov/modex/)) approach across all [ESS ](https://ess.science.energy.gov/)research necessitates model data that serves different roles for different users of that data.

Previous [ESS-DIVE](https://ess-dive.lbl.gov/) efforts to understand the needs and commonalities of MDAs took a big-picture look at ESS modeling activities and included surveying the ESS modeling community and developing a best-practices approach for MDAs. In this work, we built from the ground up, focusing instead on a single, specific codebase that is widely used across the ESS community and working to prototype and implement the vision set forth by [Simmonds et al. (2022)](https://doi.org/10.5334/dsj-2022-003).

_There is a growing need for enhanced model data discovery, readability, and traceability._

Our scope is to engage with the modeling community, establish and prototype improved reporting format for managing and archiving model data, and develop tutorial materials to offer long-term support to the community.

This work also paves the way for other ESS codebases to develop similar reporting formats.



## Review: ATS IO

ATS IO includes three output file types:

1. **visualization files (`.h5`)**,
2. **observation files (`.csv`, `.dat`, `.txt`, ...)**, and
3. **checkpoint files (`.h5`)**.

Visualization is _dense in space but sparse in time_. It saves every grid cell’s values, but realistically can only be done at a subset of timesteps. Example `xml` block:

```xml
<ParameterList name="visualization">
  <Parameter name="file name base" type="string" value="visdump_data"/>
  <Parameter name="cycles start period stop" type="Array(int)" value="{0, 100, -1}" />
  <Parameter name="cycles" type="Array(int)" value="{999, 1001}" />
  <Parameter name="times start period stop 0" type="Array(double)" value="{0.0, 10.0, 100.0}"/>
  <Parameter name="times start period stop 1" type="Array(double)" value="{100.0, 25.0, -1.0}"/>
  <Parameter name="times" type="Array(double)" value="{101.0, 303.0, 422.0}"/>
  <Parameter name="dynamic mesh" type="bool" value="false"/>
</ParameterList>
```

Observations are _sparse in space but dense in time_. They typically integrate or average a quantity across (a subset of) cells, but can be saved much more frequently (even every timestep). Therefore, they are complementary, and care should be taken to use the right one to address a given goal. Example `xml` block:

```xml
  <ParameterList name="observations" type="ParameterList">
    <ParameterList name="water_balance_computational_domain" type="ParameterList">
      <Parameter name="observation output filename" type="string" value="water_balance_computational_domain.csv" />
      <Parameter name="delimiter" type="string" value="," />
      <Parameter name="time units" type="string" value="d" />
      <Parameter name="times start period stop" type="Array(double)" value="{ 0, 1,-1}" />
      <Parameter name="times start period stop units" type="string" value="d" />
      <ParameterList name="observed quantities" type="ParameterList">
        <ParameterList name="net runoff [mol d^-1]" type="ParameterList">
          <Parameter name="variable" type="string" value="surface-water_flux" />
          <Parameter name="region" type="string" value="external_sides" />
          <Parameter name="location name" type="string" value="face" />
          <Parameter name="functional" type="string" value="extensive integral" />
          <Parameter name="direction normalized flux" type="bool" value="true" />
          <Parameter name="time integrated" type="bool" value="true" />
        </ParameterList>
        <ParameterList name="river discharge [mol d^-1]" type="ParameterList">
          <Parameter name="variable" type="string" value="surface-water_flux" />
          <Parameter name="region" type="string" value="surface domain outlet" />
          <Parameter name="location name" type="string" value="face" />
          <Parameter name="functional" type="string" value="extensive integral" />
          <Parameter name="direction normalized flux" type="bool" value="true" />
          <Parameter name="time integrated" type="bool" value="true" />
        </ParameterList>
        <ParameterList name="net groundwater flux [mol d^-1]" type="ParameterList">
          <Parameter name="variable" type="string" value="water_flux" />
          <Parameter name="region" type="string" value="external_sides" />
          <Parameter name="location name" type="string" value="face" />
          <Parameter name="functional" type="string" value="extensive integral" />
          <Parameter name="direction normalized flux" type="bool" value="true" />
          <Parameter name="time integrated" type="bool" value="true" />
        </ParameterList>
      </ParameterList>
    </ParameterList>
```

Checkpoint files are mostly an internal format that supports checkpoint/restart capabilities to allow runs to be continued and is used in regression testing. Example `xml` block:

```xml
<ParameterList name="checkpoint">
  <Parameter name="cycles start period stop" type="Array(int)" value="{0, 100, -1}" />
  <Parameter name="cycles" type="Array(int)" value="{999, 1001}" />
  <Parameter name="times start period stop 0" type="Array(double)" value="{0.0, 10.0, 100.0}"/>
  <Parameter name="times start period stop 1" type="Array(double)" value="{100.0, 25.0, -1.0}"/>
  <Parameter name="times" type="Array(double)" value="{101.0, 303.0, 422.0}"/>
</ParameterList>
```



## Review: ATS Default Names, Symbols, and Units

Source: https://raw.githubusercontent.com/amanzi/ats/refs/heads/master/docs/documentation/source/input_spec/symbol_table.org

| Variable Root Name                        | Symbol                | Description                                                                      | Units                                                              | Process   |
| ----------------------------------------- | --------------------- | -------------------------------------------------------------------------------- | ------------------------------------------------------------------ | --------- |
| coordinate, centroid                      | x, y, z        | spatial coordinates                                                              | [m]                                                             |           |
| time                                      | t                   | time variable                                                                    | [s]                                                             |           |
| cell_volume                              | V  | volume (if 3D) or area (if 2D) of a discrete element                             | [m^3] or [m^2]                                               |           |
| gravity                                   | g                   | gravitational acceleration vector                                                | [m s^{-2}]                                                    |           |
| canopy-drainage                           | D                   | flux of water dripping from the canopy to the ground below                       | [m s^{-1}]                                                    | canopy    |
| canopy-throughfall_drainage_{rain,snow} |                       | source of {rain,snow} to the respective layer, throughfall + drainage            | [m s^{-1}]                                                    | canopy    |
| canopy-evaporation                        | E_{can}            | evaporative flux of stored water from the leaf surface                           | [m s^{-1}]                                                    | canopy    |
| canopy-fracwet                            | f_{wet}            | fraction of the canopy leaf area that is covered in water                        | [-]                                                             | canopy    |
| canopy-water_content                     | Theta_{can}       |  extensive water content on the leaf surface                                 | [mol]                                      | canopy    |
| canopy-water_equivalent                  |                       | effective thickness of water (per unit surface or leaf area?)                  | [m]                                                             | canopy    |
| canopy-water_source                      |                       | sum of all sources and sinks of water to the leaf surface                        | [mol m^2 s^{-1}]                         | canopy    |
| canopy-water_source_meters              |                       | sum of all sources and sinks of water to the leaf surface                        | [m s^{-1}]                                                    | canopy    |
| canopy-interception                       | I_{can}            | flux of water to the canopy as intercepted rain or snow                          | [m s^{-1}]                                                    | canopy    |
| canopy-leaf_area_index                  | LAI                 | leaf area per unit surface area                                                  | [-]                                                             | canopy    |
| canopy-potential_transpiration           | T_{pot}            | potential transpiration, unlimited by water availability                         | [m s^{-1}]                                                    | canopy    |
| canopy-potential_transpiration_mols     | T_{pot}            | potential transpiration, unlimited by water availability                         | [mol m^{-2} s^{-1}]                      | canopy    |
| canopy-temperature                        | T_{can}            | leaf temperature, used in longwave radiation out calculation                     | [K]                                                             | canopy    |
| {canopy,snow,surface}-radiation_balance  |                       | net energy balance including radiation and conduction (Priestley-Taylor's R - G) |                                                                    | surface   |
| snow-depth                                | h_{snow}           | thickness of the snowpack                                                        | [m]                                                             | snow      |
| snow-age                                  |                       | average age of the snowpack                                                      | [day]                                                           | snow      |
| snow-density                              | rho_{snow}        | Mass density of the snow                                                         | [kg m^-3]                                                     | snow      |
| snow-melt                                 | M                   | Snow melt rate (SWE)                                                             | [m SWE s^{-1}]                               | snow      |
| snow-precipitation                        | P_{snow}           | precipitation of snow, in snow-water-equivalent (SWE)                            | [m SWE s^{-1}]                             | snow      |
| snow-evaporation                          | E_{snow}           | evaporation of snow, in snow-water-equivalent (SWE)                              | [m SWE s^{-1}]                             | snow      |
| snow-source_sink                         | Q_{snow}           | extensive sum of all sources and sinks of water as snow                          | [mol s^{-1}]                             | snow      |
| snow-water_source                        | Q_{snow}           | sum of all sources and sinks of water as snow                                    | [mol m^{-2} s^{-1}]                      | snow      |
| snow-water_source_meters                | Q_{snow}           | sum of all sources and sinks of water as snow                                    | [m s^{-1}]                                                  | snow      |
| snow-source                               |                       | sum of all sources of water as snow, excluding sinks                             | [m s^{-1}]                                                    | snow      |
| snow-death_rate                          |                       | If all snow disappears in a timestep, the effective rate of snow loss.           | [m SWE s^{-1}]                               | snow      |
| snow-water_equivalent                    | SWE                 | equivalent "ponded_depth" if one melted the snow                                | [m]                                                             | snow      |
| snow-water_content                       | Theta_{snow}      |  extensive water content in snow                                             | [mol]                                      | snow      |
| snow-temperature                          | T_{snow}           | temperature of the snowpack                                                      | [K]                                                             | snow      |
| surface-ponded_depth                     | h                   | ponded depth, or the water head over the surface                                 | [m]                                                             | flow      |
| surface-unfrozen_effective_depth        | eta h              | portion of ponded depth that is unfrozen                                         | [m]                                                             | flow      |
| surface-unfrozen_fraction                | eta                | fraction of water on the surface that is liquid (vs ice)                         | [-]                                                             | energy    |
| surface-albedo                            | alpha              | area-weighted albedo of the surface, as seen by the canopy/atmosphere            | [-]                                                             | surface   |
| surface-albedos.{bare,water,snow}         | alpha              | albedo of a given media                                                          | [-]                                                             | surface   |
| surface-emissivities.{bare,water,snow}    | epsilon            | emissivity (equivalently absorptivity) of a given media                          | [-]                                                             | surface   |
| surface-area_fractions.{bare,water,snow} | a                   | fraction of the ground surface of a given media                                  | [-]                                                             | surface   |
| surface-incoming_longwave_radiation     | Q^e_{SW}           | longwave radiation from the atmosphere                                           | [W m^{-2}]                                                    | surface   |
| surface-incoming_shortwave_radiation    | Q^e_{SW}           | shortwave radiation from the atmosphere                                          | [W m^{-2}]                                                    | surface   |
| surface-incident_shortwave_radiation    | Q^e_{SWin}         | shortwave radiation incident on a surface (of a given slope/aspect)              | [W m^{-2}]                                                    | surface   |
| surface-qE_conducted                     | Q^e_{c}            | energy conducted to the ground surface                                           | [W m^{-2}]                                                    | surface   |
| surface-qE_lw_out                       | Q^e_{LWout}        | longwave energy radiated away from the surface                                   | [W m^{-2}]                                                    | surface   |
| surface-qE_sensible_heat                | Q^e_{h}            | sensible heat flux to the atmosphere                                             | [W m^{-2}]                                                    | surface   |
| surface-qE_latent_heat                  | Q^e_{E}            | latent heat flux to the atmosphere                                               | [W m^{-2}]                                                    | surface   |
| surface-qE_snowmelt                      | Q^e_{snow}         | latent heat released via snowmelt                                                | [W m^{-2}]                                                    | surface   |
| surface-transpiration                     | T                   | actual transpiration, integrated vertically and limited by water availability    | [m s^{-1}]                                                    | flow      |
| surface-total_evapotranspiration         | ET                  | total evaporation (canopy, snow, and bare ground) plus transpiration             | [m s^{-1}]                                                    | flow      |
| surface-capillary_pressure_plant        | pc_{can}           | capillary pressure in the plant stem at the ground surface                       | [Pa]                                                            | flow      |
| surface-overland_conductivity            | k                   | coefficient for the diffusion wave equation                                      | []                                                           | flow      |
| surface-manning_coefficient              | m_n                | coefficient in Manning's equation, a measure of surface roughness                | []                                                           | flow      |
| surface-precipitation_rain               | P_{r}              | precipitation of rain                                                            | [m s^{-1}]                                                    | surface   |
| surface-air_temperature                  | T_{air}            | temperature of the air at the ground surface                                     | [K]                                                             | surface   |
| surface-vapor_pressure_air              | vp_{air}           | partial pressure of water vapor in the atmosphere                                | [Pa]                                                            | surface   |
| surface-wind_speed                       | v_{air}          | magnitude of the wind speed                                                      | [m s^{-1}]                                                    | surface   |
| surface-water_source                     | Q_s                | extensive sum of all sources and sinks of water as liquid (surface)              | [mol s^{-1}]                               | flow      |
| surface-elevation                         | z                   | elevation                                                                        | [m]                                                             |           |
| surface-aspect                            | psi                | aspect, clockwise relative to North, in [0,360)                                 | [degrees]                                                       | surface   |
| surface-slope_magnitude                  | S       | 1 - dot product of the surface's normal with the vertical                        | [-]                                                             | flow      |
| surface-water_flux                       | q_s       | surface flux vector                                                              | [mol s^{-1}]                               | flow      |
| surface-velocity.{1,2}                | V_s       | surface water velocity vector                                                    | [m s^{-1}]                                                    | flow      |
| surface-evaporative_flux                 | E                   | water sink due to evaporation                                                    | [m s^{-1}]                                                    | flow      |
| surface-evaporation                       | E                   | water sink due to evaporation                                                    | [m s^{-1}]                                                    | flow      |
| surface-soil_resistance                  | r_{soil}           | resistance of soil to water vapor transport, used in evaporation downregulation  | [-]                                                             | flow      |
| surface-subsurface_flux                  | q_{ss}   | infiltration, the flux of water into the ground                                  | [mol s^{-1}]                               | flow      |
| surface-subsurface_energy_flux          | q^e_{ss} | diffusive flux of energy into the ground                                         | [MJ s^{-1}]                                | energy    |
| surface-advected_energy_flux            | eq_s      | extensive energy flux due to advection (face-based)                              | [MJ s^{-1}]                                | energy    |
| surface-diffusive_energy_flux           | q_s^e     | extensive energy flux due to diffusion (face-based)                              | [MJ s^{-1}]                                | energy    |
| surface-water_content                    | Theta_s           |  extensive water content (liquid or ice, but not snow) of a cell             | [mol]                                        | flow      |
| surface-temperature                       | T_s                | temperature of ponded water or the ground surface                                | [K]                                                             | energy    |
| surface-source_molar_density            | n_{source}         | molar density of all water sources (surface)                                     | [mol m^{-3}]                               | flow      |
| transpiration                             | T                   | actual transpiration, vertically distributed to the subsurface                   | [mol m^-3 s^{-1}]                        | flow      |
| root_fraction                            | f_r                | fraction of all roots in this soil layer (vertically sums to 1)                  | [-]                                                             | flow      |
| permeability                              | K                   | absolute permeability                                                            | [m^2]                                                           | flow      |
| relative_permeability                | k_r                | relative conductivity, frac{n}{\mu} k                                     |                                                            | flow      |
| molar_density_{liquid,gas,ice}      | n_{l,g,i}      | molar density of a given phase                                                   | [mol m^{-3}]                               |           |
| mass_density_{liquid,gas,ice}           | rho_{l,g,i}   | mass density of a phase                                                          | [kg m^{-3}]                                |           |
| density_rock                             | rho_{rock}        | mass density of the medium                                                       | [kg m^{-3}]                                |           |
| pressure                                  | p                   | pressure of the liquid phase                                                     | [Pa]                                         | flow      |
| water_source                             | Q                   | extensive sum of all sources and sinks of water as liquid (subsurface)           | [mol s^{-1}]                               | flow      |
| source_molar_density                    | n_{source}         | molar density of all water sources (subsurface)                                  | [mol m^{-3}]                               | flow      |
| saturation_{liquid,gas,ice}              | s_{l,g,i}      | saturation of a given phase                                                      | [-]                                                             | flow      |
| capillary_pressure_{A}_{B}             | p_c^{A-B}          | capillary pressure of phase A over phase B                                       | [Pa]                                                            | flow      |
| viscosity_liquid                         | nu                 | dynamic viscosity of water                                                       | [Pa s]                                     | flow      |
| base_porosity                            | phi_0             | porosity of the undeformed medium                                                | [-]                                                             | flow      |
| porosity                                  | phi                | porosity of the medium, including any compressibility/specific storage           | [-]                                                             | flow      |
| water_flux                               | q          | extensive water flux (face-based)                                                | [mol s^{-1}]                               | flow      |
| darcy_velocity.{1,2,3}               | V          | subsurface water velocity vector                                                 | [m s^{-1}]                                                    | flow      |
| water_content                            | Theta              |  extensive water content (liquid, ice, or vapor) of a cell                   | [mol]                                      | flow      |
| temperature                               | T                   | temperature                                                                      | [K]                                                             | energy    |
| thermal_conductivity                     | kappa              | thermal conductivity of the grid cell                                            | [MW m^{-1} K^{-1}]                       | energy    |
| total_energy_source                 | Q^e                 |  extensive sum of all sources and sinks of energy                            | [MJ s^{-1}]                                | energy    |
| advected_energy_flux                    | eq         | extensive energy flux due to advection (face-based)                              | [MJ s^{-1}]                                | energy    |
| diffusive_energy_flux                   | q^e        | extensive energy flux due to diffusion (face-based)                              | [MJ s^{-1}]                                | energy    |
| internal_energy_{liquid,gas,ice,rock}   | u_X                |  specific internal energy of a given phase/medium                            | [MJ mol^{-1}]           | energy    |
| energy                                    | E                   |  extensive energy of a cell                                                  | [MJ]                                         | energy    |
| enthalpy                                  | e                   |  specific enthalpy                                                           | [MJ mol^{-1}]           | energy    |
| mole_ratio                               | xi^C               | ratio of mols of C to mols of H2O, typically in the liquid phase                 | [molC molH2O^{-1}]  | transport |
| total_component_concentration           | C                   | concentration of a component C in liquid water                                   | [mol C L^{-1}]                            | chemistry |
| mineral_volume_fractions                |                       | mineral volume fractions for solid phase reactions                               | [-]                                                             | chemistry |
| mineral_specific_surface_area          |                       | specific surface area of solid phase                                             | [m^2 (surface area) m^{-3}]                    | chemistry |
| mineral_rate_constant                   |                       | reaction rate constants for solid phase                                          |                                                                  | chemistry |
| surface_site_density                    |                       | density of sites for surface complexation                                      |                                                                  | chemistry |
| total_sorbed                             | C^{sorb}              | concentration of sorbed C                                                        | [molC L^{-1}]                             | chemistry |
| isotherm_kd                              |                       | isotherm k                                                                       |                                                                  | chemistry |
| isotherm_freundlich_n                   |                       | Freundlich's n for isotherms                                                     |                                                                  | chemistry |
| isotherm_langmuir_b                     |                       | Langmuir's b for isotherms                                                       |                                                                  | chemistry |
| first_order_decay_rate_constant       | k_{C1,C2}            | decay rate constant for first order reactions from C1 to C2                      |                                                                  | chemistry |
| cation_exchange_capacity                | CEC                   | cation exchange capacity                                                         |                                                                  | chemistry |
| aux_data                                 |                       | auxiliary data needed by the geochemical engine                                  |                                                                 | chemistry |



## Review: Model Data Archiving Guidelines

> **Info:** List of ESS-DIVE Data Reporting Formats: [https://ess-dive.lbl.gov/data-reporting-formats/](https://ess-dive.lbl.gov/data-reporting-formats/)


> **Info:** File Level Metadata Reporting Format: [https://ess-dive.gitbook.io/file-level-metadata-reporting-format/](https://ess-dive.gitbook.io/file-level-metadata-reporting-format/)


> **Info:** Model Data Archiving Guidelines ([Simmonds et al. 2022](http://doi.org/10.5334/dsj-2022-003)): [https://ess-dive.gitbook.io/model-data-archiving-guidelines/](https://ess-dive.gitbook.io/model-data-archiving-guidelines/)


The outline specified by the MDA guidelines is:

1. Model data archiving guidelines
   1. Metadata
   2. Required Data Files
      1. Model Inputs
      2. Model Outputs
      3. Model Code
      4. Scripts
   3. Optional Files
      1. File-level metadata (FLMD)
      2. Model Testing Data
      3. Documentation or user guide
   4. Use in publications
2. Deciding how to bundle files
3. File-Level Metadata

> **Info:** See [https://ess-dive.gitbook.io/model-data-archiving-guidelines/](https://ess-dive.gitbook.io/model-data-archiving-guidelines/) for more details.




## ATS MDA Reporting Format v1.0.0

Driven by community feedback collected through a user survey, best practices established by experienced model users, and recommendations provided by model developers, we have developed the ESS-DIVE ATS MDA Reporting Format. This Reporting Format is designed to improve the consistency, transparency, and accessibility of data produced by ATS modeling activities, enabling better data sharing, traceability, and long-term usability across the hydrologic modeling community and beyond.

### Summary

### To Include

* ESS-DIVE metadata files
* ATS mesh file
* ATS config file
* **Processed** ATS input files
* ATS final checkpoint files
* ATS observation files
* ATS visualization files for non-spinup & non-ensemble transient runs
* ATS metadata files accompanying visualization files for non-spinup & non-ensemble transient runs
* ATS version and Watershed Workflow version
* ATS job submission scripts and slurm output files (if HPC)
* Manuscript-associated files, including figures and plotting scripts

### Not To Include

* ATS source code
* Watershed Workflow source code
* **Raw** model input files
* **Raw** model evaluation files
* **Raw** data used for any other purposes
* ATS periodic checkpoint files
* ATS visualization files for spinup & non-ensemble transient runs
* ATS metadata files accompanying visualization files for spinup & non-ensemble transient runs

> **Info:** Processed input files must be ATS-readable, e.g., `mywatershed_MODIS_LAI.h5`; raw input files cannot be directly read in ATS, e.g., `MOD10A2.061_500m_aid0001.nc`.


### Specific

#### Metadata files

| File Type                                 | Include? |
| ----------------------------------------- | -------- |
| ESS-DIVE Data dictionary file (`dd.csv`)           | YES      |
| ESS-DIVE File level metadata file (`flmd.csv`)     | YES      |
| Readme file (e.g., `.txt/.docx/.pdf/.md`) | YES      |

#### Manuscript-associated files

| File Type                                                                  | Include?    |
| -------------------------------------------------------------------------- | ----------- |
| Figures (e.g., `.png`/`.jpg`/`.pdf`/`.eps`)                                | YES         |
| Plotting scripts (e.g., `.py`/`.ipynb`/`.r`/`.m`)                          | YES         |
| Data behind the plots (e.g., `.csv`/`.dat`/`.h5`)                          | YES         |
| Open data list (in Appendix/Supplementary Material/Supporting Information) | RECOMMENDED |

#### Model input files and model evaluation data files

| File Type                              | Include? |
| -------------------------------------- | -------- |
| ATS model config file (`.xml`)         | YES      |
| ATS mesh file (`.exo`)                 | YES      |
| Watershed Workflow notebook (`.ipynb`) | YES      |
| Meteorological forcing data (`.h5`)    | YES      |
| Leaf Area Index data (`.h5`)           | YES      |
| Other user-defined input data (`.h5`)  | YES      |
| ATS version                            | YES      |
| Watershed Workflow version             | YES      |
| ATS source code                        | NO       |
| WW source code                         | NO       |
| Raw USGS/EPA/etc. data (`.csv/.dat`)   | NO       |
| Raw MODIS data (`.nc`)                 | NO       |
| Raw other data                         | NO       |

#### Model output files (spinup runs and ensemble runs)

| File Type                                                                | Include     |
| ------------------------------------------------------------------------ | ------------ |
| ATS metadata files accompanying visualization files (`.xmf`)             | NO           |
| ATS visualization files (`.h5`)                                          | NO           |
| ATS periodic checkpoint files (`.h5`)                                    | NO           |
| ATS final checkpoint files (`.h5`)                                       | YES          |
| ATS observation files (`.csv`/`.dat`)                                    | YES          |
| ATS job submission scripts (`.sh`) and slurm output files (`slurm*.out`) | YES (if HPC) |

#### Model output files (transient runs/'production' runs)

| File Type                                                                       | Include     |
| ------------------------------------------------------------------------------- | ------------ |
| ATS metadata files accompanying visualization files (`.xmf`) (grouped & zipped) | YES          |
| ATS visualization files (`.h5`)                                                 | YES          |
| ATS periodic checkpoint files (`.h5`)                                           | NO           |
| ATS final checkpoint files (`.h5`)                                              | YES          |
| ATS observation files (`.csv`/`.dat`)                                           | YES          |
| ATS job submission scripts (`.sh`) and slurm output files (`slurm*.out`)        | YES (if HPC) |



## ATS MDA Workflow: A Step-by-Step Guide

> **Info:** This guide assumes that a set of ATS simulations has already completed on a local machine or an HPC platform. The goal is to produce a curated directory suitable for publication and long-term reuse.


> **Info:** The full, executable workflow is implemented in the Jupyter notebook in this repository (see `ats_mda_workflow.ipynb`, or use direct link: https://github.com/ess-dive-workspace/essdive-ATS-model-data-archiving/blob/main/ats_mda_workflow.ipynb). This section stays close to that notebook and highlights the key steps users typically edit.


### Step 0 — Configure paths and workflow options

In the notebook, you edit a single **configuration block** to point to:

- the **source** ATS simulation directory (`simulation_dir`), and
- the **destination** curated package directory (`data_pkg_dir`, commonly named `my_ATS_MDA`).

You also control which files are copied and how downstream metadata is generated.

Key configuration fields include:

- `include_extensions`: file extensions to include (e.g., `xml`, `exo`, `h5`, `csv`)
- `include_name_globs`: filename patterns to include even if the extension is not listed (e.g., `slurm*`)
- `run_tokens`: tokens used to identify run directories for post-copy cleanup (default `run0/run1/run2`)
- `keep_checkpoint_token`: token used to preserve final checkpoints (default `final`)
- `obs_file_handle`, `obs_file_format`: how a representative observation CSV is selected to build `dd.csv`

### Step 1 — Validate the source directory and prepare the destination

The notebook checks that the source exists and creates `data_pkg_dir` if needed.

Practical note: treat `data_pkg_dir` as a **disposable staging area** until you have reviewed the package content.

### Step 2 — Copy publishable artifacts into `data_pkg_dir`

The notebook uses `rsync` (when available) to copy only selected file types while preserving the directory structure.
It runs `rsync` in live mode with progress enabled so you can see per-file transfer status.

- If `rsync` is not available on your system, the notebook falls back to a slower Python-based copy.

### Step 3 — Post-copy cleanup (remove bulky intermediates)

Many ATS run directories contain large intermediate files that are not typically required for publication.
The notebook performs a best-effort cleanup within detected run directories:

- removes **non-final** checkpoint files (keeps only those whose filename contains `keep_checkpoint_token`),
- removes Paraview `*.xmf` metadata files, and
- removes visualization time-series files matching `ats_vis_*.h5`.

#### Run directories are not guaranteed

Users may have **some** (not all) of `run0`, `run1`, `run2`, or they may use different naming.
The notebook therefore:

- searches for directories whose names contain any token in `run_tokens`,
- proceeds if it finds **at least one** matching directory, and
- raises an error if it finds **none** (because it has nothing to operate on).

If your run directories are named differently, update `run_tokens` accordingly.

### Step 4 — Enumerate all files and generate `flmd.csv`

The notebook inventories all files under `data_pkg_dir` and writes a first-pass **File Level Metadata** table:

- `flmd.csv` lists each file name and its relative path.
- The notebook adds a few lightweight, pattern-based description hints.

You should review and edit `flmd.csv` to ensure file descriptions are accurate and complete.

### Step 5 — Build a data dictionary (`dd.csv`) from a representative observation CSV

To support reuse of tabular outputs, the notebook builds a **Data Dictionary** (`dd.csv`) by parsing column headers from a representative output CSV.

- It searches for files matching `f"{obs_file_handle}*.{obs_file_format}"`.
- It auto-detects a header line (best effort).
- If auto-detection fails, you can set a manual header line index in the configuration (`header_line_hint`, 0-based).

### Step 6 — Auto-fill variable definitions (best effort)

When network access is available, the notebook attempts to download the ATS input-spec **symbol table** from the ATS repository and uses it to auto-fill `Definition` entries in `dd.csv`.

This step is heuristic and incomplete by design; you should review the definitions.
If the download fails (e.g., offline environment), the notebook continues and leaves definitions blank.

### Step 7 — Optional: create a checksum manifest

The notebook can generate a `sha256sums.txt` file for all files in `data_pkg_dir`. This is optional but useful for verifying integrity after copying or uploading.

### Step 8 — Suggested next step: upload to ESS-DIVE

The notebook concludes with a short checklist for uploading your curated directory to ESS-DIVE, including reminders to provide dataset-level metadata and include the generated `flmd.csv` and `dd.csv`.

### Step 9 — Optional: create per-subdirectory tarballs (with automatic splitting > 5 GiB)

For large packages, the notebook can create one `*.tar.gz` archive **per immediate subdirectory** under `data_pkg_dir`.

Example outputs:

- `run0.tar.gz`, `run1.tar.gz`, `run2.tar.gz`

The notebook then reports archive sizes. If any archive exceeds **5 GiB**, it uses `split` to create `5G` parts:

- `run0.tar.gz.part001`, `run0.tar.gz.part002`, ...

A reconstruction recipe is provided in the notebook:

```bash
cat run0.tar.gz.part* > run0.tar.gz
gzip -t run0.tar.gz
tar -tzf run0.tar.gz | head
```


## Funding and Acknowledgements

ATS MDA Reporting Format is built under ESS-DIVE Partner Project: Improving Advanced Terrestrial Simulator (ATS) model data managing and archiving standards ([https://ess-dive.lbl.gov/partner-projects/](https://ess-dive.lbl.gov/partner-projects/)). ESS-DIVE is funded by the U.S. Department of Energy, Office of Science, Office of Biological and Environmental Research, Earth and Environmental Sciences Division, Data Management program under contract number DE-AC02-05CH11231. ESS-DIVE uses resources of the National Energy Research Scientific Computing Center (NERSC), a DOE Office of Science User Facility operated under Contract No. DE-AC02-05CH11231.




# FAQ

### What does the workflow produce?

A curated directory (commonly `my_ATS_MDA/`) containing the files you intend to publish, plus:

- `flmd.csv` (file inventory and file-level descriptions)
- `dd.csv` (data dictionary for at least one representative tabular output)
- optionally `sha256sums.txt` (integrity checks)
- optionally per-subdirectory `*.tar.gz` archives and split parts for large transfers


### Does the workflow modify my original simulation directory?

No. The workflow **copies** selected files from `simulation_dir` into `data_pkg_dir`, and any cleanup/removal actions are performed **only** inside `data_pkg_dir`.


### I do not have `run0/`, `run1/`, or `run2/`. Will the workflow fail?

Not necessarily. The cleanup step only requires **at least one** run directory whose name contains a token listed in `run_tokens`.

- If you have run directories with different names, update `run_tokens` in the configuration.
- If **no** run directories match any token, the cleanup step raises an error. In that case, either adjust `run_tokens` or skip/modify the cleanup cell.

### My run directories have names like `spinup_runA` and `production_runB`. What should I set `run_tokens` to?

Set `run_tokens` to substrings that appear in those directory names (for example, `("runA", "runB")`). The notebook matches by substring.

### I cannot see copy progress during the `rsync` step. What should I check?

The notebook runs `rsync` with progress enabled. If you do not see progress:

- confirm `rsync` is available on your system (`which rsync`), and
- ensure you are running the notebook in an environment where subprocess output is shown (typical for Jupyter).

If `rsync` is not available, the notebook falls back to a Python-based copy method (slower and without `rsync`-style progress).

### How do I include additional file types (or exclude something)?

Edit `include_extensions` and `include_name_globs` in the configuration block.

A practical approach is to start with a conservative list, run the copy step, then adjust based on what is missing or what should be omitted.

### The notebook removed files I want to keep (e.g., `*.xmf` or `ats_vis_*.h5`). What should I do?

Edit the cleanup cell in the notebook to match your publication needs. The provided cleanup rules reflect a common archiving preference, but they are not mandatory.

### The data dictionary (`dd.csv`) header parsing did not work for my CSV.

Use `header_line_hint` (0-based line index) to manually specify the header row. The notebook will then re-parse the header from that line.

If your CSV uses a different convention (e.g., units on a second header row), adjust the parsing logic in the notebook accordingly.


### I have multiple observation CSV types. How do I generate `dd.csv` for each?

The notebook builds `dd.csv` from **one representative CSV** (selected by `obs_file_handle` and `obs_file_format`).

If you want data dictionaries for multiple CSV schemas, repeat the `dd.csv` generation step with different `obs_file_handle` values and save each output under a distinct filename (e.g., `dd_water_balance.csv`, `dd_energy_balance.csv`).

### The symbol-table download step failed.

That step requires network access to retrieve the ATS symbol table. If you are offline (or the download is blocked), the workflow continues and leaves `dd.csv` definitions blank. You can fill them manually.


### Why are some `dd.csv` definitions blank even when the symbol table loads?

Auto-filling is **best effort**. Some output column names will not have a matching entry in the ATS symbol table, and the matching logic is heuristic. Blank definitions are expected and should be filled manually as needed.

### How do I verify that my upload or transfer did not corrupt files?

If you generated `sha256sums.txt`, you can verify on a Linux/HPC system after transfer:

```bash
sha256sum -c sha256sums.txt
```



### Which checkpoint files are retained by default?

During cleanup, the notebook removes checkpoint files matching `checkpoint*.h5` **unless** the filename contains `keep_checkpoint_token` (default: `final`).

If your final checkpoint naming differs, update `keep_checkpoint_token` in the configuration.

### Where are tarballs and split parts written?

By default, tarballs are written **next to the directories they archive**, i.e., into `data_pkg_dir`. The notebook function also supports writing archives to a separate output directory if you prefer to keep packaging artifacts elsewhere.

### What if the `split` command is not available on my system?

The automatic splitting step requires the `split` executable. If it is not available, you can either:

- run the tar/split step on a system where `split` is available, or
- disable splitting and manage large archives using site-specific transfer tooling.

### One of my `*.tar.gz` files is larger than 5 GiB. What happens?

If you enable the tar/split step, the notebook automatically splits large archives into `5G` parts named:

- `name.tar.gz.part001`, `name.tar.gz.part002`, ...

You can upload the parts individually.

### How do I merge split parts back into a single `*.tar.gz`?

On Linux/HPC:

```bash
cat run0.tar.gz.part* > run0.tar.gz
gzip -t run0.tar.gz
tar -xzf run0.tar.gz
```

The numeric padding in the filenames ensures correct ordering.


# Help Center




  
    
      **Check if your questions have been answered in FAQ**— when you have general questions
      [https://github.com/ess-dive-workspace/essdive-ATS-model-data-archiving/edit/main/instructions.md#faq](https://github.com/ess-dive-workspace/essdive-ATS-model-data-archiving/edit/main/instructions.md#faq)
    
    
      **Ask the 150+ members in ATS User Google Group**
      — when you have ATS-related questions
      [https://groups.google.com/g/ats-users](https://groups.google.com/g/ats-users)
    
    
      **Ask ESS-DIVE staff**
      — when you have ESS-DIVE-related questions
      [https://ess-dive.lbl.gov/contact/](https://ess-dive.lbl.gov/contact/)
